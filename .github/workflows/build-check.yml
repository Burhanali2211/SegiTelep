name: Production Build Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-check:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install dependencies
      run: npm ci
    
    - name: Check React chunking
      run: |
        echo "ğŸ” Checking React chunking configuration..."
        if grep -q "return null" vite.config.ts && grep -q "react/" vite.config.ts; then
          echo "âœ… React chunking protection is in place"
        else
          echo "âŒ React chunking protection missing!"
          exit 1
        fi
    
    - name: Check React imports
      run: |
        echo "ğŸ” Checking React imports..."
        if grep -q "import React" src/main.tsx && grep -q "import React" src/App.tsx; then
          echo "âœ… React imports are in place"
        else
          echo "âŒ React imports missing!"
          exit 1
        fi
    
    - name: Check HashRouter
      run: |
        echo "ğŸ” Checking HashRouter usage..."
        if grep -q "HashRouter" src/App.tsx && ! grep -q "BrowserRouter" src/App.tsx; then
          echo "âœ… HashRouter is being used"
        else
          echo "âŒ BrowserRouter detected or HashRouter missing!"
          exit 1
        fi
    
    - name: Check environment variables
      run: |
        echo "ğŸ” Checking environment variable usage..."
        if grep -r "process\.env" src/; then
          echo "âŒ process.env usage detected!"
          exit 1
        else
          echo "âœ… No process.env usage found"
        fi
    
    - name: Build frontend
      run: npm run build
    
    - name: Check build output
      run: |
        echo "ğŸ” Checking build output..."
        if [ -f "dist/index.html" ] && [ -d "dist/assets" ]; then
          echo "âœ… Frontend build successful"
          
          # Check for React in vendor chunks
          if ls dist/assets/*react*.js 2>/dev/null; then
            echo "âŒ React found in vendor chunks!"
            exit 1
          else
            echo "âœ… React not in separate vendor chunks"
          fi
        else
          echo "âŒ Frontend build failed!"
          exit 1
        fi
    
    - name: Build Tauri app
      run: npm run tauri build
    
    - name: Check Tauri build
      run: |
        echo "ğŸ” Checking Tauri build..."
        if [ -f "src-tauri/target/release/segitelep.exe" ]; then
          echo "âœ… Tauri build successful"
        else
          echo "âŒ Tauri build failed!"
          exit 1
        fi
    
    - name: Production check complete
      run: |
        echo "ğŸ‰ All production checks passed!"
        echo "React context error prevention: âœ…"
        echo "Tauri compatibility: âœ…"
        echo "Build reliability: âœ…"
